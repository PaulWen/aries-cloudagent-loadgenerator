version: "3.7"
services:

  grafana:
    container_name: grafana
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      GF_RENDERING_SERVER_URL: http://grafana-image-renderer:8081/render
      GF_RENDERING_CALLBACK_URL: http://grafana:3000/
      GF_LOG_FILTERS: rendering:debug
    volumes:
      - grafana-volume:/var/lib/grafana
      - ./grafana/grafana-provisioning:/etc/grafana/provisioning
      - ./grafana/grafana.ini:/etc/grafana/grafana.ini
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - grafana-image-renderer
      - loki
    networks:
      - dashboard-and-logging

  # https://grafana.com/grafana/plugins/grafana-image-renderer/#installation
  grafana-image-renderer:
    container_name: grafana-image-renderer
    image: grafana/grafana-image-renderer:latest
    ports:
      - 8081
    networks:
      - dashboard-and-logging

  # https://github.com/IzakMarais/reporter
  grafana-pdf-exporter:
    container_name: grafana-pdf-exporter
    image: izakmarais/grafana-reporter
    entrypoint: "/usr/local/bin/grafana-reporter -ip grafana:3000 -grid-layout=1"
    ports:
      - 8686:8686
    depends_on:
      - grafana
      - grafana-image-renderer
    networks:
      - dashboard-and-logging

  loki:
    container_name: loki
    image: grafana/loki:2.4.2
    ports:
      - 3100:3100
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki-volume:/data/loki
      - ./loki/local-config.yaml:/etc/loki/local-config.yaml
    networks:
      - dashboard-and-logging

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    environment:
      - DOZZLE_BASE=/dozzle
      - DOZZLE_LEVEL=DEBUG
      - DOZZLE_USERNAME=view
      - DOZZLE_PASSWORD=8R1uVAwRn3eyjKPj1A4iZggWTay9IOa5kEYFyaoM
      - DOZZLE_KEY=7zocTTANMOOH3eZVXmD5DShm4ja1vQmfoHqZRh3a
      - DOZZLE_NO_ANALYTICS=true
    networks:
      - dashboard-and-logging
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 9999:8080

networks:
  dashboard-and-logging:
    name: dashboard-and-logging

volumes:
  grafana-volume:
  loki-volume:
